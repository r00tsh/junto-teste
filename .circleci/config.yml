version: 2.1
orbs:
  node: circleci/node@5
jobs:
  lint-dockerfile:
    docker:
      - image: alpine
    steps:
      - checkout
      - run:
          name: Dockerfile Lint
          environment:
            HADOLINT_VERSION: v2.12.0
          command: |
            apk add --no-cache curl
            curl -L https://github.com/hadolint/hadolint/releases/download/$HADOLINT_VERSION/hadolint-Linux-x86_64 --output /usr/local/bin/hadolint
            chmod +x /usr/local/bin/hadolint
            hadolint Dockerfile
    
  test-node:
    executor: node/default
    working_directory: ~/project/app
    steps:
      - checkout:
          path: ~/project
      - node/install-packages:
          cache-path: ~/project/node_modules
          override-ci-command: npm install
      - run:
          name: Run tests
          command: npm test --passWithNoTests

  build-push:
    docker:
      - image: cimg/base:stable
    steps:
      - setup_remote_docker:
          version: default
      - checkout
      - run: |
          export GIT_REPO_NAME=$(basename $(git remote get-url origin) | cut -f1 -d'.')
          export GIT_CURRENT_VERSION=$(git rev-parse --short HEAD)
          echo "export GIT_CURRENT_VERSION=$GIT_CURRENT_VERSION" >> $BASH_ENV
          echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
          docker buildx build --push --tag $REPO/$GIT_REPO_NAME:$GIT_CURRENT_VERSION --platform $ARCH .
    environment:
      ARCH: "linux/amd64,linux/arm/v7,linux/arm64"
      REPO: rootsh

workflows:
  lint-test:
    jobs:
      - lint-dockerfile:
          filters:
            branches:
              ignore:
              - main
      - test-node:
          filters:
            branches:
              ignore:
                - main

  build-deploy:
      jobs:
       - build-push:
          context: docker_hub
          filters:
            branches:
              ignore:
                - main